(function($,elementor){'use strict';if(!window.SpexoAiTextField||typeof window.SpexoAiTextField!=='object'){window.SpexoAiTextField=window.SpexoAiTextField||{ajax_url:ajaxurl||'',generate_action:'spexo_ai_generate_text',generate_nonce:'',change_action:'spexo_ai_change_text',change_nonce:'',settings_url:''}}
var activeObservers=[];var tokenUsageData={initialized:!1,dailyUsed:0,dailyLimit:0,limitReached:!1,apiKeyValid:!1};function checkTokenLimit(callback){if(tokenUsageData.initialized){if(callback){callback({limitReached:tokenUsageData.limitReached,apiKeyValid:Boolean(tokenUsageData.apiKeyValid),})}
return tokenUsageData.limitReached||!tokenUsageData.apiKeyValid}
$.post(SpexoAiTextField.ajax_url,{action:'spexo_ai_text_check_limits',nonce:SpexoAiTextField.generate_nonce},function(response){if(response.success&&response.data){tokenUsageData.initialized=!0;tokenUsageData.dailyUsed=parseInt(response.data.daily_used||0);tokenUsageData.dailyLimit=parseInt(response.data.daily_limit||0);tokenUsageData.limitReached=response.data.limit_reached===!0;tokenUsageData.apiKeyValid=response.data.api_key_valid===!0;if(callback){callback({limitReached:tokenUsageData.limitReached,apiKeyValid:tokenUsageData.apiKeyValid,})}}else{if(callback){callback({limitReached:!1,apiKeyValid:!0,})}}}).fail(function(){if(callback){callback({limitReached:!1,apiKeyValid:!0,})}})}
function updateTokenUsage(usageData){if(usageData&&typeof usageData==='object'){tokenUsageData.initialized=!0;tokenUsageData.dailyUsed=parseInt(usageData.daily_used||0);tokenUsageData.dailyLimit=parseInt(usageData.daily_limit||0);tokenUsageData.limitReached=tokenUsageData.dailyLimit>0&&tokenUsageData.dailyUsed>=tokenUsageData.dailyLimit}}
function injectAnimationStyles(){if($('#spexo-addons-ai-animations').length===0){const animationStyles=`
                <style id="spexo-addons-ai-animations">
                    @keyframes spexoAddonsPulse {
                        0% { box-shadow: 0 0 0 0 rgba(91,3,255,0.4), inset 0 0 0 1px rgba(91,3,255,0.4); }
                        50% { box-shadow: 0 0 0 5px rgba(91,3,255,0.2), inset 0 0 0 1px rgba(91,3,255,0.6); }
                        100% { box-shadow: 0 0 0 0 rgba(91,3,255,0.1), inset 0 0 0 1px rgba(91,3,255,0.4); }
                    }
                    @keyframes spexoAddonsShine {
                        0% { background-position: -100px; }
                        40%, 100% { background-position: 140px; }
                    }
                    @keyframes spexoAddonsRotatePulse {
                        0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
                        50% { transform: scale(1.15) rotate(180deg); filter: brightness(1.2) drop-shadow(0 0 3px rgba(91,3,255,0.7)); }
                        100% { transform: scale(1) rotate(360deg); filter: brightness(1); }
                    }
                    @keyframes spexoAddonsGlow {
                        0% { filter: brightness(1) drop-shadow(0 0 1px rgba(91,3,255,0.5)); }
                        50% { filter: brightness(1.3) drop-shadow(0 0 3px rgba(91,3,255,0.8)); }
                        100% { filter: brightness(1) drop-shadow(0 0 1px rgba(91,3,255,0.5)); }
                    }
                    .spexo-addons-field-pulsing {
                        animation: spexoAddonsPulse 1.5s infinite cubic-bezier(0.66, 0, 0, 1) !important;
                        border-color: #6A1B9A !important;
                    }
                    .spexo-addons-field-shine {
                        background-image: linear-gradient(90deg, 
                            rgba(106,27,154,0) 0%, 
                            rgba(106,27,154,0.2) 25%, 
                            rgba(233,30,99,0.3) 50%, 
                            rgba(106,27,154,0.2) 75%, 
                            rgba(106,27,154,0) 100%);
                        background-position: -100px;
                        background-size: 140px 100%;
                        background-repeat: no-repeat;
                        animation: spexoAddonsShine 2s infinite linear;
                    }
                    .spexo-addons-wysiwyg-active {
                        outline: 2px solid #5B03FF !important;
                        outline-offset: -2px;
                        transition: all 0.3s ease;
                    }
                    .spexo-addons-ai-buttons-wrapper {
                        display: inline-flex;
                        align-items: center;
                        gap: 12px;
                        position: relative;
                        z-index: 5;
                        transition: all 0.3s ease;
                        margin-top: 8px;
                        width: 100%;
                    }
                    .spexo-addons-ai-buttons-wrapper.is-processing .ai-generate-btn,
                    .spexo-addons-ai-buttons-wrapper.is-processing .ai-change-btn {
                        background: linear-gradient(135deg, #7B1FA2, #D81B60) !important;
                        opacity: 0.8;
                        cursor: default;
                        box-shadow: 0 2px 8px rgba(106, 27, 154, 0.3) !important;
                        pointer-events: none;
                    }
                    .spexo-addons-ai-buttons-wrapper.is-processing img {
                        filter: grayscale(100%);
                    }
                    .ai-prompt-container {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin: 8px 0;
                        position: relative;
                        z-index: 4;
                    }
                    .elementor-control-type-wysiwyg .ai-prompt-container {
                        margin-top: 6px;
                        margin-bottom: 10px;
                        width: 100%;
                    }
                    .ai-prompt-input {
                        flex: 1;
                        min-width: 0;
                        padding: 6px 10px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        font-size: 12px;
                    }
                    .ai-prompt-input:focus {
                        border-color: #5B03FF;
                        box-shadow: 0 0 0 1px rgba(91,3,255,0.3);
                        outline: none;
                    }
                    .ai-prompt-examples {
                        font-size: 11px;
                        color: #6d7882;
                        margin-top: 4px;
                        line-height: 1.4;
                    }
                    .ai-prompt-examples strong {
                        color: #556068;
                        font-weight: 500;
                    }
                    .ai-prompt-cancel {
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border: 1px solid #ccc;
                        background: #fff;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                        color: #555;
                    }
                    .ai-prompt-submit {
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        padding: 4px;
                        background: linear-gradient(135deg, #7B1FA2, #D81B60) !important;
                        border: unset;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    .ai-prompt-submit.is-processing {
                        background: linear-gradient(135deg, #6A1B9A, #E91E63) !important;
                        border-color: transparent !important;
                    }
                    .ai-prompt-submit.is-processing img {
                        animation: spexoAddonsRotatePulse 2s infinite ease-in-out;
                    }
                    .ai-prompt-submit.is-processing:after {
                        content: '';
                        position: absolute;
                        top: -2px;
                        left: -2px;
                        right: -2px;
                        bottom: -2px;
                        border-radius: 6px;
                        background: transparent;
                        animation: spexoAddonsPulse 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
                        z-index: -1;
                    }
                </style>
            `;$('head').append(animationStyles)}}
function injectAiButtons($container){injectAnimationStyles();$container.find('.elementor-control-type-text label.elementor-control-title, .elementor-control-type-textarea label.elementor-control-title').each(function(){var $label=$(this);var $ctrlWrap=$label.closest('.elementor-control');if($ctrlWrap.hasClass('elementor-control-_element_id')||$ctrlWrap.hasClass('elementor-control-_css_classes')||$ctrlWrap.hasClass('elementor-label-inline')){return}
var $input=$ctrlWrap.find('input[type="text"], textarea');if(!$input.length||$label.next('.spexo-addons-ai-buttons-wrapper').length){return}
createAndAttachButtons($label,$input,$ctrlWrap,!0)});$container.find('.elementor-control-type-wysiwyg .elementor-control-input-wrapper').each(function(){var $inputWrapper=$(this);var $ctrlWrap=$inputWrapper.closest('.elementor-control');var $textarea=$ctrlWrap.find('textarea.elementor-wp-editor');if(!$textarea.length||$ctrlWrap.find('.spexo-addons-ai-buttons-wrapper').length){return}
createAndAttachButtons($ctrlWrap,$textarea,$ctrlWrap,!1)})}
function createAndAttachButtons($attachTarget,$field,$ctrlWrap,attachAfterLabel){var fieldName=$field.attr('name')||$field.attr('id')||'';var isWysiwyg=$ctrlWrap.hasClass('elementor-control-type-wysiwyg');var $buttonsWrapper=$('<div class="spexo-addons-ai-buttons-wrapper"></div>');if(isWysiwyg){var $inputWrapper=$ctrlWrap.find('.elementor-control-input-wrapper');if(!$inputWrapper.length)return}
var $btnLabel=$('<button type="button" class="ai-generate-btn ai-generate-btn--futuristic" title="AI Generate"></button>').css({verticalAlign:'middle',padding:'4px 8px',fontSize:'12px',cursor:'pointer',background:'linear-gradient(135deg, #6A1B9A, #E91E63)',border:'none',borderRadius:'4px',color:'#ffffff',display:'inline-flex',alignItems:'center',boxShadow:'none',transition:'box-shadow 0.3s ease'});$btnLabel.append($('<img>').attr('src',SpexoAiTextField.icon_url).css({marginRight:'6px',width:'16px',height:'16px',verticalAlign:'middle'}),$('<span>').addClass('ai-generate-btn__label').text('AI Generate'));$btnLabel.hover(function(){$(this).css('boxShadow','0 0 8px rgba(106,27,154,0.9), 0 0 16px rgba(233,30,99,0.7)')},function(){$(this).css('boxShadow','none')});var $changeBtn=$btnLabel.clone();$changeBtn.removeClass('ai-generate-btn').addClass('ai-change-btn');$changeBtn.find('span.ai-generate-btn__label').text('AI Change');$changeBtn.attr('title','AI Change');$changeBtn.find('img').attr('src',SpexoAiTextField.rewrite_icon_url||SpexoAiTextField.plugin_url+'/inc/modules/ai/assets/images/ai-rewrite.svg');$changeBtn.hover(function(){$(this).css('boxShadow','0 0 8px rgba(106,27,154,0.9), 0 0 16px rgba(233,30,99,0.7)')},function(){$(this).css('boxShadow','none')});$buttonsWrapper.append($btnLabel).append($changeBtn);if(isWysiwyg){$inputWrapper.before($buttonsWrapper)}else if(attachAfterLabel){$attachTarget.after($buttonsWrapper)}else{$attachTarget.before($buttonsWrapper)}
$btnLabel.on('click',function(e){e.preventDefault();var $originalBtn=$(this);var $buttonsWrapper=$originalBtn.closest('.spexo-addons-ai-buttons-wrapper');$buttonsWrapper.addClass('is-processing');checkTokenLimit(function(status){if(!status.apiKeyValid){var $errorMessage=$('<div class="spexo-addons-ai-error-message"></div>').css({background:'#e7f3fe',color:'#084d7a',padding:'10px 15px',borderRadius:'4px',border:'1px solid #b6e0fe',marginTop:'8px',marginBottom:'8px',fontSize:'13px',fontWeight:'500',lineHeight:'1.4',display:'flex',alignItems:'center',justifyContent:'space-between'});var settingsUrl=window.SpexoAiTextField&&window.SpexoAiTextField.settings_url?window.SpexoAiTextField.settings_url:'/wp-admin/admin.php?page=spexo-ai-settings';$errorMessage.html('<span>OpenAI API key is missing or invalid. Please configure your API key in AI Settings.</span>'+'<a href="'+settingsUrl+'" style="color:#0073aa;text-decoration:underline;white-space:nowrap;margin-left:10px;" target="_blank">Settings</a>');$errorMessage.insertAfter($buttonsWrapper).hide().fadeIn(200);setTimeout(function(){$errorMessage.fadeOut(200,function(){$(this).remove()})},5000);$buttonsWrapper.removeClass('is-processing');return}
if(status.limitReached){var $errorMessage=$('<div class="spexo-addons-ai-error-message"></div>').css({background:'#ffecec',color:'#d63638',padding:'10px 15px',borderRadius:'4px',border:'1px solid #d63638',marginTop:'8px',marginBottom:'8px',fontSize:'13px',fontWeight:'500',display:'flex',alignItems:'center',justifyContent:'space-between'});var settingsUrl=window.SpexoAiTextField&&window.SpexoAiTextField.settings_url?window.SpexoAiTextField.settings_url:'/wp-admin/admin.php?page=spexo-ai-settings';$errorMessage.html('<span>Daily token limit reached. Please try again tomorrow or increase the limit in AI Settings.</span>'+'<a href="'+settingsUrl+'" style="color:#0073aa;text-decoration:underline;white-space:nowrap;margin-left:10px;" target="_blank">Settings</a>');$errorMessage.insertAfter($buttonsWrapper).hide().fadeIn(200);setTimeout(function(){$errorMessage.fadeOut(200,function(){$(this).remove()})},5000);$buttonsWrapper.removeClass('is-processing');return}
var $promptContainer=$('<div class="ai-prompt-container"></div>');var $promptInput=$('<input type="text" class="ai-prompt-input" placeholder="Enter your prompt..."/>');var $examplesText;if(isWysiwyg){$examplesText=$('<div class="ai-prompt-examples">Examples: <strong>"Write about product benefits"</strong>, <strong>"Create a FAQ section with 3 questions"</strong>, <strong>"Write a product description for beginners"</strong></div>')}else{$examplesText=$('<div class="ai-prompt-examples">Examples: <strong>"Create a compelling headline"</strong>, <strong>"Write a call to action"</strong>, <strong>"Generate a short bio"</strong></div>')}
var $submitBtn=$('<button type="button" class="ai-prompt-submit" title="Submit"></button>');$submitBtn.append($('<img>').attr('src',SpexoAiTextField.icon_url).css({width:'16px',height:'16px'}));var $cancelBtn=$('<button type="button" class="ai-prompt-cancel" title="Cancel">✕</button>');if(isWysiwyg){var $inputWrapper=$ctrlWrap.find('.elementor-control-input-wrapper');if(!$inputWrapper.length)return;$promptContainer.append($promptInput,$submitBtn,$cancelBtn);$inputWrapper.before($promptContainer);$promptContainer.after($examplesText);$promptContainer.hide().fadeIn(200);$examplesText.hide().fadeIn(200)}else{$promptContainer.append($promptInput,$submitBtn,$cancelBtn).insertAfter($buttonsWrapper).hide().fadeIn(200);$promptContainer.after($examplesText);$examplesText.hide().fadeIn(200)}
$promptInput.focus();$promptInput.on('keydown',function(e){if(e.key==='Enter'){e.preventDefault();$submitBtn.trigger('click')}});$cancelBtn.on('click',function(){$promptContainer.fadeOut(200,function(){$(this).remove();$examplesText.remove();$buttonsWrapper.removeClass('is-processing')})});$submitBtn.on('click',function(){var userPrompt=$promptInput.val().trim();if(!userPrompt){$promptInput.css('borderColor','red');return}
$promptInput.prop('disabled',!0);$submitBtn.prop('disabled',!0).addClass('is-processing');if(isWysiwyg){var $editorWrap=$field.closest('.wp-editor-container');var $iframe=$editorWrap.find('iframe');$editorWrap.addClass('spexo-addons-field-pulsing');if($iframe.length){$iframe.addClass('spexo-addons-wysiwyg-active');try{$($iframe[0].contentDocument.body).addClass('spexo-addons-field-shine')}catch(e){console.error('Could not access iframe body',e)}}}else{$field.addClass('spexo-addons-field-pulsing');$field.addClass('spexo-addons-field-shine')}
$.post(SpexoAiTextField.ajax_url,{action:SpexoAiTextField.generate_action||'spexo_ai_generate_text',nonce:SpexoAiTextField.generate_nonce||SpexoAiTextField.nonce,field_name:fieldName,prompt:userPrompt,editor_type:isWysiwyg?'wysiwyg':'text'},function(response){if(response.success&&response.data.text){updateFieldValue($field,response.data.text,isWysiwyg,response);if(response.data.usage){updateTokenUsage(response.data.usage)}}else if(response.data&&response.data.message){alert(response.data.message)}}).always(function(){if(isWysiwyg){var $editorWrap=$field.closest('.wp-editor-container');var $iframe=$editorWrap.find('iframe');$editorWrap.removeClass('spexo-addons-field-pulsing');if($iframe.length){$iframe.removeClass('spexo-addons-wysiwyg-active');try{$($iframe[0].contentDocument.body).removeClass('spexo-addons-field-shine')}catch(e){console.error('Could not access iframe body',e)}}}else{$field.removeClass('spexo-addons-field-pulsing spexo-addons-field-shine')}
$submitBtn.removeClass('is-processing');$promptContainer.fadeOut(200,function(){$(this).remove();$examplesText.remove();$buttonsWrapper.removeClass('is-processing')})})})})});$changeBtn.on('click',function(e){e.preventDefault();var $originalBtn=$(this);var $buttonsWrapper=$originalBtn.closest('.spexo-addons-ai-buttons-wrapper');$buttonsWrapper.addClass('is-processing');checkTokenLimit(function(status){if(!status.apiKeyValid){var $errorMessage=$('<div class="spexo-addons-ai-error-message"></div>').css({background:'#ffecec',color:'#d63638',padding:'10px 15px',borderRadius:'4px',border:'1px solid #d63638',marginTop:'8px',marginBottom:'8px',fontSize:'13px',fontWeight:'500',display:'flex',alignItems:'center',justifyContent:'space-between'});var settingsUrl=window.SpexoAiTextField&&window.SpexoAiTextField.settings_url?window.SpexoAiTextField.settings_url:'/wp-admin/admin.php?page=spexo-ai-settings';$errorMessage.html('<span>OpenAI API key is missing or invalid. Please configure your API key in AI Settings.</span>'+'<a href="'+settingsUrl+'" style="color:#0073aa;text-decoration:underline;white-space:nowrap;margin-left:10px;" target="_blank">Settings</a>');$errorMessage.insertAfter($buttonsWrapper).hide().fadeIn(200);setTimeout(function(){$errorMessage.fadeOut(200,function(){$(this).remove()})},5000);$buttonsWrapper.removeClass('is-processing');return}
if(status.limitReached){var $errorMessage=$('<div class="spexo-addons-ai-error-message"></div>').css({background:'#ffecec',color:'#d63638',padding:'10px 15px',borderRadius:'4px',border:'1px solid #d63638',marginTop:'8px',marginBottom:'8px',fontSize:'13px',fontWeight:'500',display:'flex',alignItems:'center',justifyContent:'space-between'});var settingsUrl=window.SpexoAiTextField&&window.SpexoAiTextField.settings_url?window.SpexoAiTextField.settings_url:'/wp-admin/admin.php?page=spexo-ai-settings';$errorMessage.html('<span>Daily token limit reached. Please try again tomorrow or increase the limit in AI Settings.</span>'+'<a href="'+settingsUrl+'" style="color:#0073aa;text-decoration:underline;white-space:nowrap;margin-left:10px;" target="_blank">Settings</a>');$errorMessage.insertAfter($buttonsWrapper).hide().fadeIn(200);setTimeout(function(){$errorMessage.fadeOut(200,function(){$(this).remove()})},5000);$buttonsWrapper.removeClass('is-processing');return}
var originalText=getFieldValue($field,isWysiwyg);var $promptContainer=$('<div class="ai-prompt-container"></div>');var $promptInput=$('<input type="text" class="ai-prompt-input" placeholder="Enter change prompt..."/>');var $examplesText;if(isWysiwyg){$examplesText=$('<div class="ai-prompt-examples">Examples: <strong>"Add 2 paragraphs about benefits"</strong>, <strong>"Add 3 paragraphs about features"</strong>, <strong>"Make content more professional"</strong></div>')}else{$examplesText=$('<div class="ai-prompt-examples">Examples: <strong>"Make it more persuasive"</strong>, <strong>"Make it shorter and direct"</strong>, <strong>"Change tone to friendly"</strong></div>')}
var $submitBtn=$('<button type="button" class="ai-prompt-submit" title="Apply"></button>');$submitBtn.append($('<img>').attr('src',SpexoAiTextField.icon_url).css({width:'16px',height:'16px'}));var $cancelBtn=$('<button type="button" class="ai-prompt-cancel" title="Cancel">✕</button>');if(isWysiwyg){var $inputWrapper=$ctrlWrap.find('.elementor-control-input-wrapper');if(!$inputWrapper.length)return;$promptContainer.append($promptInput,$submitBtn,$cancelBtn);$inputWrapper.before($promptContainer);$promptContainer.after($examplesText);$promptContainer.hide().fadeIn(200);$examplesText.hide().fadeIn(200)}else{$promptContainer.append($promptInput,$submitBtn,$cancelBtn).insertAfter($buttonsWrapper).hide().fadeIn(200);$promptContainer.after($examplesText);$examplesText.hide().fadeIn(200)}
$promptInput.focus().on('keydown',function(ev){if(ev.key==='Enter'){ev.preventDefault();$submitBtn.click()}});$cancelBtn.on('click',function(){$promptContainer.fadeOut(200,function(){$(this).remove();$examplesText.remove();$buttonsWrapper.removeClass('is-processing')})});$submitBtn.on('click',function(){var promptVal=$promptInput.val().trim();if(!promptVal){$promptInput.css('borderColor','red');return}
$promptInput.prop('disabled',!0);$submitBtn.prop('disabled',!0).addClass('is-processing');if(isWysiwyg){var $editorWrap=$field.closest('.wp-editor-container');var $iframe=$editorWrap.find('iframe');$editorWrap.addClass('spexo-addons-field-pulsing');if($iframe.length){$iframe.addClass('spexo-addons-wysiwyg-active');try{$($iframe[0].contentDocument.body).addClass('spexo-addons-field-shine')}catch(e){console.error('Could not access iframe body',e)}}}else{$field.addClass('spexo-addons-field-pulsing');$field.addClass('spexo-addons-field-shine')}
$.post(SpexoAiTextField.ajax_url,{action:SpexoAiTextField.change_action,nonce:SpexoAiTextField.change_nonce,field_name:fieldName,prompt:promptVal,original:originalText,editor_type:isWysiwyg?'wysiwyg':'text',instruction_context:'Modify the original text based on the user instructions. If asked to add content, keep the original and expand it. If asked to change style, maintain the same information but change the tone. Return the complete modified text.'},function(resp){if(resp.success&&resp.data.text){updateFieldValue($field,resp.data.text,isWysiwyg,resp);if(resp.data.usage){updateTokenUsage(resp.data.usage)}}else if(resp.data&&resp.data.message){alert(resp.data.message)}}).always(function(){if(isWysiwyg){var $editorWrap=$field.closest('.wp-editor-container');var $iframe=$editorWrap.find('iframe');$editorWrap.removeClass('spexo-addons-field-pulsing');if($iframe.length){$iframe.removeClass('spexo-addons-wysiwyg-active');try{$($iframe[0].contentDocument.body).removeClass('spexo-addons-field-shine')}catch(e){console.error('Could not access iframe body',e)}}}else{$field.removeClass('spexo-addons-field-pulsing spexo-addons-field-shine')}
$submitBtn.removeClass('is-processing');$promptContainer.fadeOut(200,function(){$(this).remove();$examplesText.remove();$buttonsWrapper.removeClass('is-processing')})})})})})}
function updateFieldValue($field,value,isWysiwyg,response){var appendMode=response&&response.data&&response.data.append_mode===!0;var originalContent=appendMode?(response.data.original||''):'';if(isWysiwyg){var editorId=$field.attr('id');if(!editorId){console.error('Spexo Addons: No editor ID found for WYSIWYG field');if(appendMode){$field.val(originalContent+'\n\n'+value)}else{$field.val(value)}
$field.trigger('input');return}
if(value){value=value.replace(/^```(?:html|HTML)?\s*/g,'');value=value.replace(/```\s*$/g,'');if(!value.includes('<p>')&&!value.includes('<div>')){value=value.replace(/\r\n/g,'\n').replace(/\r/g,'\n');var paragraphDelimiter=/\n\s*\n/;if(!paragraphDelimiter.test(value)&&value.includes('\n')){value=value.split('\n').filter(function(para){return para.trim().length>0}).map(function(para){return'<p>'+para.trim()+'</p>'}).join('')}else{value=value.split(paragraphDelimiter).map(function(paragraph){return'<p>'+paragraph.trim().replace(/\n/g,'<br>')+'</p>'}).join('')}}}
try{if(window.tinymce&&tinymce.get(editorId)){var editor=tinymce.get(editorId);if(!editor.isHidden()){if(appendMode){var existingContent=originalContent||'';var newContent=value||'';if(existingContent&&!existingContent.trim().endsWith('</p>')){existingContent=existingContent+'<p></p>'}
editor.setContent(existingContent+newContent)}else{editor.setContent(value)}
editor.save()}else{if(appendMode){var existingContent=originalContent||'';var newContent=value||'';if(existingContent&&!existingContent.trim().endsWith('</p>')&&(existingContent.includes('<p>')||newContent.includes('<p>'))){existingContent=existingContent+'<p></p>'}else if(existingContent){existingContent=existingContent+'\n\n'}
$field.val(existingContent+newContent)}else{$field.val(value)}}}else{if(appendMode){$field.val(originalContent+'\n\n'+value)}else{$field.val(value)}}}catch(e){console.error('Spexo Addons: Error updating WYSIWYG content',e);if(appendMode){var existingContent=originalContent||'';var newContent=value||'';if(existingContent&&!existingContent.trim().endsWith('</p>')&&(existingContent.includes('<p>')||newContent.includes('<p>'))){existingContent=existingContent+'<p></p>'}else if(existingContent){existingContent=existingContent+'\n\n'}
$field.val(existingContent+newContent)}else{$field.val(value)}}}else{if(appendMode){$field.val(originalContent+'\n\n'+value)}else{$field.val(value)}}
$field.trigger('input');$field.trigger('change');if(isWysiwyg&&window.tinymce&&tinymce.get($field.attr('id'))){try{tinymce.get($field.attr('id')).fire('change')}catch(e){console.error('Spexo Addons: Error triggering TinyMCE change event',e)}}}
function getFieldValue($field,isWysiwyg){if(isWysiwyg){var editorId=$field.attr('id');if(window.tinymce&&tinymce.get(editorId)&&!tinymce.get(editorId).isHidden()){return tinymce.get(editorId).getContent()}else{return $field.val()}}
return $field.val()}
function setupControlsObserver(panel){var $controlsContainer=panel.$el;activeObservers.forEach(function(observer){observer.disconnect()});activeObservers=[];var observer=new MutationObserver(function(mutations){setTimeout(function(){injectAiButtons($controlsContainer)},50)});observer.observe($controlsContainer[0],{childList:!0,subtree:!0});activeObservers.push(observer);setTimeout(function(){injectAiButtons($controlsContainer)},150)}
function waitForElementor(){if(typeof elementor!=='undefined'&&elementor.hooks){elementor.hooks.addAction('panel/open_editor/widget',function(panel){setTimeout(function(){setupControlsObserver(panel)},250)})}else{setTimeout(waitForElementor,100)}}
waitForElementor();function waitForElementorChannels(){if(typeof elementor!=='undefined'&&elementor.channels&&elementor.channels.editor){elementor.channels.editor.on('section:activated',function(sectionName,editor){var panel=editor.getOption('editedElementView').getContainer().panel;if(panel&&panel.$el){setTimeout(function(){setupControlsObserver(panel)},150)}})}else{setTimeout(waitForElementorChannels,100)}}
waitForElementorChannels()})(jQuery,window.elementor)