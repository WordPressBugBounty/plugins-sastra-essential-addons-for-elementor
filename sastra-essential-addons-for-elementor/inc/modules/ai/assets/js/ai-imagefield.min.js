(function($,elementor){'use strict';if(!window.SpexoAiImageField){return}
var data=window.SpexoAiImageField;function injectImageGeneratorStyles(){if($('#spexo-ai-image-generator-styles').length===0){const styles=`
                <style id="spexo-ai-image-generator-styles">
                    /* Spexo AI Image Generator Button Styles */
                    .spexo-ai-image-generate-btn {
                        background: linear-gradient(135deg, #6A1B9A, #E91E63) !important;
                        border: none !important;
                        color: white !important;
                        padding: 8px 12px !important;
                        border-radius: 6px !important;
                        font-size: 12px !important;
                        font-weight: 500 !important;
                        cursor: pointer !important;
                        display: inline-flex !important;
                        align-items: center !important;
                        gap: 6px !important;
                        transition: all 0.3s ease !important;
                        margin: 0 !important;
                        position: relative !important;
                        z-index: 10 !important;
                        text-decoration: none !important;
                        outline: none !important;
                        box-shadow: 0 2px 8px rgba(106, 27, 154, 0.3) !important;
                    }
                    .spexo-ai-image-generate-btn:hover {
                        background: linear-gradient(135deg, #7B1FA2, #D81B60) !important;
                        box-shadow: 0 4px 16px rgba(106, 27, 154, 0.4) !important;
                        transform: translateY(-1px) !important;
                    }
                    .spexo-ai-image-generate-btn:active {
                        transform: translateY(0) !important;
                        box-shadow: 0 2px 8px rgba(106, 27, 154, 0.3) !important;
                    }
                    .spexo-ai-image-generate-btn img {
                        width: 16px !important;
                        height: 16px !important;
                        flex-shrink: 0 !important;
                    }
                    .spexo-ai-image-generate-btn span {
                        white-space: nowrap !important;
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                    }
                    
                    /* Submit button in prompt container */
                    .spexo-ai-image-submit {
                        background: linear-gradient(135deg, #6A1B9A, #E91E63) !important;
                        color: white !important;
                        border: none !important;
                        padding: 6px 12px !important;
                        border-radius: 3px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        box-shadow: 0 2px 8px rgba(106, 27, 154, 0.3) !important;
                    }
                    .spexo-ai-image-submit:hover {
                        background: linear-gradient(135deg, #7B1FA2, #D81B60) !important;
                        box-shadow: 0 4px 16px rgba(106, 27, 154, 0.4) !important;
                        transform: translateY(-1px) !important;
                    }
                </style>
            `;$('head').append(styles)}}
function injectImageControls($container){injectImageGeneratorStyles();$container.find('.elementor-control.elementor-control-type-media, '+'.elementor-control.elementor-control-type-image, '+'.elementor-control.elementor-control-type-gallery').each(function(){var $ctrl=$(this);if($ctrl.find('.spexo-ai-image-btn-wrapper').length){return}
var $mediaTitle=$ctrl.find('.elementor-control-field.elementor-control-media > .elementor-control-title').first();if(!$mediaTitle.length){$mediaTitle=$ctrl.find('.elementor-control-title').first()}
var $outer=$('<div class="spexo-ai-image-field-wrapper"></div>');var $inputWrapper=$ctrl.find('.elementor-control-input-wrapper').first();if($inputWrapper.length){$inputWrapper.after($outer)}else{$mediaTitle.after($outer)}
var $wrapper=$('<div class="spexo-ai-image-btn-wrapper" style="margin-top:8px;"></div>');var $btn=$('<button type="button" class="spexo-ai-image-generate-btn elementor-button elementor-size-sm"><img src="'+data.icon_url+'" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;"/><span>Generate Image with Spexo</span></button>');$outer.append($wrapper);$wrapper.append($btn);$btn.on('click',function(e){e.preventDefault();$outer.find('.spexo-ai-image-prompt-container').remove();var apiKeyValid=!0;$.ajax({url:SpexoAiImageField.ajax_url,method:'POST',async:!1,dataType:'json',data:{action:'spexo_ai_image_check_limits',nonce:SpexoAiImageField.generate_nonce},success:function(resp){apiKeyValid=resp.success&&resp.data.api_key_valid===!0},error:function(){apiKeyValid=!0}});if(!apiKeyValid){var settingsUrl=window.SpexoAiImageField&&window.SpexoAiImageField.settings_url?window.SpexoAiImageField.settings_url:'/wp-admin/admin.php?page=spexo-ai-settings';var $errorMessage=$('<div class="spexo-ai-image-error-message"></div>').css({background:'#e7f3fe',color:'#084d7a',padding:'10px 15px',borderRadius:'4px',border:'1px solid #b6e0fe',margin:'8px 0',fontSize:'13px',fontWeight:'500',display:'flex',alignItems:'center',justifyContent:'space-between'});$errorMessage.html('<span>OpenAI API key is missing or invalid. Please configure your API key in AI Settings.</span>'+'<a href="'+settingsUrl+'" style="color:#0073aa;text-decoration:underline;white-space:nowrap;margin-left:10px;" target="_blank">Settings</a>');$wrapper.after($errorMessage).hide().fadeIn(200);setTimeout(function(){$errorMessage.fadeOut(200,function(){$(this).remove()})},5000);return}
var $promptContainer=$('<div class="spexo-ai-image-prompt-container"></div>').css({margin:'8px 0'});$btn.prop('disabled',!0);$btn.css('opacity',0.5);var $input=$('<input type="text" class="spexo-ai-image-prompt-input" placeholder="Enter image prompt..." style="width:100%;padding:6px 10px;border:1px solid #ccc;border-radius:4px;margin-bottom:6px;"/>');var $quality=$('<select class="spexo-ai-image-quality" style="margin-right:6px;"></select>');var $resolution=$('<select class="spexo-ai-image-resolution" style="margin-right:6px;"></select>');var is_pro=SpexoAiImageField.is_pro!==undefined?SpexoAiImageField.is_pro:!1;var $modelSelect=$('<select class="spexo-ai-image-model" style="margin-right:6px;"></select>');if(!is_pro){$modelSelect.prop('disabled',!0).css({'opacity':'0.6','cursor':'not-allowed'})}
var imageModels=[{value:'dall-e-3',label:'DALL·E 3'},{value:'gpt-image-1',label:'GPT Image 1'}];imageModels.forEach(function(m){$modelSelect.append('<option value="'+m.value+'">'+m.label+'</option>')});if(is_pro&&SpexoAiImageField.image_model){$modelSelect.val(SpexoAiImageField.image_model)}else{$modelSelect.val('dall-e-3')}
var modelControls={'dall-e-3':{qualities:[{value:'hd',label:'HD (default)'},{value:'standard',label:'Standard'}],sizes:[{value:'1024x1024',label:'1024×1024 (square)'},{value:'1024x1792',label:'1024×1792 (portrait)'},{value:'1792x1024',label:'1792×1024 (landscape)'}]},'gpt-image-1':{qualities:[{value:'high',label:'High (default)'},{value:'medium',label:'Medium'},{value:'low',label:'Low'},{value:'auto',label:'Auto'},],sizes:[{value:'auto',label:'Auto (default)'},{value:'1024x1024',label:'1024×1024 (square)'},{value:'1536x1024',label:'1536×1024 (landscape)'},{value:'1024x1536',label:'1024×1536 (portrait)'}]}};function updateControls(){var model=$modelSelect.val();var controls=modelControls[model];if(controls){$quality.empty();controls.qualities.forEach(function(q){$quality.append('<option value="'+q.value+'">'+q.label+'</option>')});$resolution.empty();controls.sizes.forEach(function(s){$resolution.append('<option value="'+s.value+'">'+s.label+'</option>')})}}
updateControls();$modelSelect.on('change',updateControls);var $bgCheckboxLabel=$('<label class="spexo-ai-image-bg-checkbox-label" style="margin-right:6px;margin-bottom:8px;margin-top:8px;display:none;"><input type="checkbox" class="spexo-ai-image-bg-checkbox" style="margin-right:8px;"/>Transparent background</label>');function updateBgCheckbox(){var $bgRow=$bgCheckboxLabel.closest('.spexo-ai-image-field-row');if($modelSelect.val()==='gpt-image-1'){$bgCheckboxLabel.show();if($bgRow.length){$bgRow.show()}}else{$bgCheckboxLabel.hide().find('input').prop('checked',!1);if($bgRow.length){$bgRow.hide()}}}
$modelSelect.on('change',updateBgCheckbox);updateBgCheckbox();var $submit=$('<button type="button" class="spexo-ai-image-prompt-submit elementor-button elementor-button-primary elementor-size-sm"><img src="'+data.icon_url+'" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;"/><span>Generate</span></button>').css({marginRight:'6px'});var $cancel=$('<button type="button" class="spexo-ai-image-prompt-cancel elementor-button elementor-button-link elementor-size-sm" title="Cancel"><span class="spexo-ai-cancel-icon">✕</span></button>');$promptContainer.append($input,$('<div class="spexo-ai-image-field-row"></div>').append('<label class="spexo-ai-image-field-label">Quality</label>',$quality),$('<div class="spexo-ai-image-field-row"></div>').append('<label class="spexo-ai-image-field-label">Size</label>',$resolution),$('<div class="spexo-ai-image-field-row"></div>').append('<label class="spexo-ai-image-field-label">Model</label>',$modelSelect),$('<div class="spexo-ai-image-field-row"></div>').append($bgCheckboxLabel),!is_pro?'<p class="spexo-ai-pro-notice" style="margin: 8px 0 12px 0; padding: 8px 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 12px; color: #856404; line-height: 1.5;">⚠️ <strong>Model selection</strong> is only available in the <a href="'+(SpexoAiImageField.settings_url||'')+'" target="_blank" style="color: #0073aa; text-decoration: underline;">Pro version</a>.</p>':'',$('<div class="spexo-ai-image-field-row spexo-ai-image-field-row--buttons"></div>').append($submit,$cancel),$('<p class="spexo-ai-image-prompt-note">Complex prompts may take up to 2 minutes to process.</p>'));$outer.append($promptContainer);$btn.addClass('is-active');$input.focus();$submit.on('click',function(){var prompt=$input.val().trim();if(!prompt){$input.css('border-color','red');return}
$submit.prop('disabled',!0).addClass('is-processing').find('span').text('Generating...');var $preview=$ctrl.find('.elementor-control-media__preview');if($preview.length){$preview.addClass('spexo-ai-field-pulsing')}
var $mediaArea=$ctrl.find('.elementor-control-media__area');if($mediaArea.length){$mediaArea.addClass('spexo-ai-image-generating')}
var $mediaTools=$ctrl.find('.elementor-control-media__tools');if($mediaTools.length){$mediaTools.addClass('spexo-ai-image-generating')}
$btn.addClass('is-active');var selectedModel=is_pro?$modelSelect.val():'dall-e-3';var requestData={action:'spexo_ai_generate_image',nonce:SpexoAiImageField.generate_nonce,prompt:prompt,quality:$quality.val(),size:$resolution.val(),model:selectedModel};if(is_pro&&selectedModel==='gpt-image-1'&&$bgCheckboxLabel.find('input').is(':checked')){requestData.background='transparent'}
$.post(SpexoAiImageField.ajax_url,requestData,function(response){if(response.success&&response.data.attachment_id){var attachmentID=response.data.attachment_id;var imageURL=response.data.url;var currentElement=elementor.getPanelView().getCurrentPageView().getOption('editedElementView');if(currentElement){var controlName=$ctrl.find('input[type="hidden"][data-setting]').data('setting');if(controlName){var imageData={id:attachmentID,url:imageURL};var settings={};settings[controlName]=imageData;$e.run('document/elements/settings',{container:currentElement.getContainer(),settings:settings});if($preview.length){$preview.css('background-image','url('+imageURL+')')}}}
$btn.prop('disabled',!1);$btn.css('opacity',1)}else{alert('Error generating image. '+(response.data&&response.data.message?response.data.message:'Unknown error occurred'));$btn.prop('disabled',!1);$btn.css('opacity',1)}}).fail(function(response){var errorMessage='Unknown error occurred';if(response.responseJSON&&response.responseJSON.data&&response.responseJSON.data.message){errorMessage=response.responseJSON.data.message}else if(response.responseText){try{var parsed=JSON.parse(response.responseText);if(parsed.data&&parsed.data.message){errorMessage=parsed.data.message}}catch(e){}}
alert('Error generating image. '+errorMessage);$btn.prop('disabled',!1);$btn.css('opacity',1)}).always(function(){$submit.prop('disabled',!1).removeClass('is-processing').find('span').text('Generate');if(typeof $preview!=='undefined'&&$preview.length){$preview.removeClass('spexo-ai-field-pulsing')}
if(typeof $mediaArea!=='undefined'&&$mediaArea.length){$mediaArea.removeClass('spexo-ai-image-generating')}
if(typeof $mediaTools!=='undefined'&&$mediaTools.length){$mediaTools.removeClass('spexo-ai-image-generating')}
$btn.removeClass('is-active');$btn.prop('disabled',!1);$btn.css('opacity',1);setTimeout(function(){$promptContainer.remove()},500)})});$cancel.on('click',function(){$btn.removeClass('is-active');$promptContainer.remove();$btn.prop('disabled',!1);$btn.css('opacity',1)})})})}
var __spexoGlobalObserver=new MutationObserver(function(mutations){mutations.forEach(function(mutation){Array.prototype.forEach.call(mutation.addedNodes,function(node){if(node.nodeType!==1){return}
var $node=$(node);var $mediaField=$node.is('.elementor-control-field.elementor-control-media')?$node:$node.find('.elementor-control-field.elementor-control-media');if(!$mediaField.length){return}
var $ctrl=$mediaField.closest('.elementor-control.elementor-control-type-media, .elementor-control.elementor-control-type-image, .elementor-control.elementor-control-type-gallery');if(!$ctrl.length){return}
var $panel=$ctrl.closest('.elementor-panel');if($panel.length){injectImageControls($panel)}})})});__spexoGlobalObserver.observe(document.body,{childList:!0,subtree:!0});function waitForElementor(){if(typeof elementor!=='undefined'&&elementor.hooks){elementor.hooks.addAction('panel/open_editor/widget',function(panel){var $panelEl=panel.$el;setTimeout(function(){injectImageControls($panelEl)},250);var root=$panelEl[0];if(!root.__spexoAiObserver){var observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){Array.prototype.forEach.call(mutation.addedNodes,function(node){if(node.nodeType===1&&(node.matches('.elementor-control.elementor-control-type-media, .elementor-control.elementor-control-type-image, .elementor-control.elementor-control-type-gallery')||$(node).find('.elementor-control.elementor-control-type-media, .elementor-control.elementor-control-type-image, .elementor-control.elementor-control-type-gallery').length)){injectImageControls($panelEl)}})})});observer.observe(root,{childList:!0,subtree:!0});root.__spexoAiObserver=observer}
setTimeout(function(){injectImageControls($panelEl)},800);setTimeout(function(){injectImageControls($panelEl)},1500)});elementor.channels.editor.on('section:activated',function(sectionName,editor){var panelView=editor.getOption('editedElementView').getContainer().panel;if(panelView&&panelView.$el){setTimeout(function(){injectImageControls(panelView.$el)},150)}});elementor.hooks.addAction('panel/open_editor/control',function(controlView){var panelEl=controlView.$el.closest('.elementor-panel');if(panelEl.length){injectImageControls(panelEl)}})}else{setTimeout(waitForElementor,100)}}
waitForElementor()})(jQuery,window.elementor)